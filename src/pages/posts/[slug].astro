---
import Layout from "@/layouts/Layout.astro";
import { SITE } from "@/config";
import { blocksToHtml } from "@/lib/block-to-html";
import fs from "node:fs";
import path from "node:path";

interface Post {
	id: string;
	title: string;
	slug: string;
	description: string | null;
	tags: string[];
	lastUpdated: string | null;
	lastEditedTime: string;
	blocks: unknown[];
}

export function getStaticPaths() {
	const postsPath = path.join(process.cwd(), "data", "posts.json");

	if (!fs.existsSync(postsPath)) {
		return [];
	}

	const posts: Post[] = JSON.parse(fs.readFileSync(postsPath, "utf-8"));

	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

const { post } = Astro.props as { post: Post };

const publishedDatesPath = path.join(process.cwd(), "data", "published-dates.json");
let publishedDates: Record<string, string> = {};

if (fs.existsSync(publishedDatesPath)) {
	publishedDates = JSON.parse(fs.readFileSync(publishedDatesPath, "utf-8"));
}

const publishedDate = publishedDates[post.slug] || post.lastEditedTime.split("T")[0];
const content = blocksToHtml(post.blocks as Parameters<typeof blocksToHtml>[0]);

function formatDate(dateStr: string): string {
	return new Date(dateStr).toLocaleDateString(SITE.language, {
		year: "numeric",
		month: "long",
		day: "numeric",
	});
}
---

<Layout title={post.title} description={post.description || undefined}>
	<article>
		<header>
			<h1>{post.title}</h1>
			<time datetime={publishedDate}>{formatDate(publishedDate)}</time>
			{post.tags.length > 0 && (
				<ul class="tags">
					{post.tags.map((tag) => (
						<li>{tag}</li>
					))}
				</ul>
			)}
		</header>
		<div class="content" data-pagefind-body set:html={content} />
	</article>
</Layout>

<style>
	article header {
		margin-bottom: 2rem;
	}
	article h1 {
		margin-bottom: 0.5rem;
	}
	article time {
		color: #666;
	}
	.tags {
		display: flex;
		gap: 0.5rem;
		list-style: none;
		padding: 0;
		margin-top: 1rem;
	}
	.tags li {
		background: #f0f0f0;
		padding: 0.25rem 0.5rem;
		border-radius: 0.25rem;
		font-size: 0.875rem;
	}
</style>
