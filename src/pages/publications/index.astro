---
import fs from "node:fs";
import path from "node:path";
import { SITE } from "@/config";
import Layout from "@/layouts/Layout.astro";

interface Post {
	id: string;
	title: string;
	slug: string;
	type: string;
	description: string | null;
	tags: string[];
	lastEditedTime: string;
}

const postsPath = path.join(process.cwd(), "data", "posts.json");
const publishedDatesPath = path.join(process.cwd(), "data", "published-dates.json");

let posts: Post[] = [];
let publishedDates: Record<string, string> = {};

if (fs.existsSync(postsPath)) {
	const allPosts: Post[] = JSON.parse(fs.readFileSync(postsPath, "utf-8"));
	posts = allPosts.filter((p) => p.type === "publication");
}

if (fs.existsSync(publishedDatesPath)) {
	publishedDates = JSON.parse(fs.readFileSync(publishedDatesPath, "utf-8"));
}

// 출판일 기준 내림차순 정렬
posts.sort((a, b) => {
	const dateA = publishedDates[a.slug] || a.lastEditedTime;
	const dateB = publishedDates[b.slug] || b.lastEditedTime;
	return new Date(dateB).getTime() - new Date(dateA).getTime();
});

function formatDate(dateStr: string): string {
	return new Date(dateStr).toLocaleDateString(SITE.language, {
		year: "numeric",
		month: "long",
		day: "numeric",
	});
}
---

<Layout title="Publications">
	<header>
		<h1>Publications</h1>
		<p class="subtitle">긴 기술 글, 튜토리얼, 심층 분석</p>
	</header>

	{posts.length === 0 ? (
		<p>아직 글이 없습니다.</p>
	) : (
		<div class="posts">
			{posts.map((post) => (
				<article>
					<h2><a href={`/publications/${post.slug}`}>{post.title}</a></h2>
					<time datetime={publishedDates[post.slug] || post.lastEditedTime}>
						{formatDate(publishedDates[post.slug] || post.lastEditedTime)}
					</time>
					{post.description && <p class="description">{post.description}</p>}
					{post.tags.length > 0 && (
						<p class="tags">{post.tags.join(", ")}</p>
					)}
				</article>
			))}
		</div>
	)}
</Layout>

<style>
	header {
		margin-bottom: 2rem;
	}
	.subtitle {
		color: #666;
		margin-top: 0.5rem;
	}
	.posts {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}
	article {
		padding-bottom: 2rem;
		border-bottom: 1px solid #eee;
	}
	article:last-child {
		border-bottom: none;
	}
	article h2 {
		margin-bottom: 0.5rem;
	}
	article h2 a {
		text-decoration: none;
	}
	article h2 a:hover {
		text-decoration: underline;
	}
	article time {
		display: block;
		color: #666;
		font-size: 0.875rem;
	}
	.description {
		margin-top: 0.5rem;
		color: #444;
	}
	.tags {
		margin-top: 0.5rem;
		font-size: 0.875rem;
		color: #666;
	}
</style>
