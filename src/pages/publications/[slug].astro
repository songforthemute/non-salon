---
import fs from "node:fs";
import path from "node:path";
import { SITE } from "@/config";
import Layout from "@/layouts/Layout.astro";
import { blocksToHtml } from "@/lib/block-to-html";

interface Post {
	id: string;
	title: string;
	slug: string;
	type: string;
	description: string | null;
	tags: string[];
	lastUpdated: string | null;
	lastEditedTime: string;
	blocks: unknown[];
}

export function getStaticPaths() {
	const postsPath = path.join(process.cwd(), "data", "posts.json");

	if (!fs.existsSync(postsPath)) {
		return [];
	}

	const posts: Post[] = JSON.parse(fs.readFileSync(postsPath, "utf-8"));
	const publications = posts.filter((p) => p.type === "publication");

	return publications.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

const { post } = Astro.props as { post: Post };

const publishedDatesPath = path.join(process.cwd(), "data", "published-dates.json");
let publishedDates: Record<string, string> = {};

if (fs.existsSync(publishedDatesPath)) {
	publishedDates = JSON.parse(fs.readFileSync(publishedDatesPath, "utf-8"));
}

const publishedDate = publishedDates[post.slug] || post.lastEditedTime.split("T")[0];
const content = blocksToHtml(post.blocks as Parameters<typeof blocksToHtml>[0]);

function formatDate(dateStr: string): string {
	return new Date(dateStr).toLocaleDateString(SITE.language, {
		year: "numeric",
		month: "long",
		day: "numeric",
	});
}
---

<Layout title={post.title} description={post.description || undefined}>
	<article>
		<header>
			<h1>{post.title}</h1>
			<time datetime={publishedDate}>{formatDate(publishedDate)}</time>
			{post.tags.length > 0 && (
				<p class="tags">{post.tags.join(", ")}</p>
			)}
		</header>
		<div class="content" data-pagefind-body set:html={content} />
	</article>
</Layout>

<style>
	article header {
		margin-bottom: 2rem;
	}
	article h1 {
		margin-bottom: 0.5rem;
	}
	article time {
		color: #666;
	}
	.tags {
		margin-top: 0.5rem;
		font-size: 0.875rem;
		color: #666;
	}
</style>
